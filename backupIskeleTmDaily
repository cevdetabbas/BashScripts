#!/bin/bash
cd /home/tm
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
TARFILE="/root/tm_Backup_${TIMESTAMP}.tar"
ZSTFILE="/root/tm_Backup_${TIMESTAMP}.tar.zst"
LOGFILE="/home/tm/Desktop/Iskele-Backup-Summary.log"
START_TIME=$(date +%s)

# Backup iÅŸlemleri
tar -cf "$TARFILE" ./Scripts ./zEnaktars .bashrc .profile .bash_history .viminfo
ORIG_SIZE=$(du -h "$TARFILE" | cut -f1)
COMP_START=$(date +%s)

zstd -19 "$TARFILE" -o "$ZSTFILE"
COMP_TIME=$(( $(date +%s) - COMP_START ))
COMP_SIZE=$(du -h "$ZSTFILE" | cut -f1)

SCP_START=$(date +%s)
REMOTE_BACKUP="admin@cybertron:E:\IskeleDailyBackups"
scp "$ZSTFILE" "$REMOTE_BACKUP"
SCP_EXIT=$?  # SCP exit code kontrolÃ¼
SCP_TIME=$(( $(date +%s) - SCP_START ))

# âœ… TEMÄ°ZLIK - SCP baÅŸarÄ±lÄ±ysa ZST de sil
rm "$TARFILE"
if [ $SCP_EXIT -eq 0 ]; then
    rm "$ZSTFILE"
    CLEANUP_STATUS="âœ… FULL CLEANUP"
else
    CLEANUP_STATUS="âš ï¸  ZST LOCAL KALDI (SCP failed)"
fi

TOTAL_TIME=$(( $(date +%s) - START_TIME ))

# âœ… LOG - SAÄž |'SIZ ÅžIK BOX
HEADER="Iskele Backup: $(date +%Y-%m-%d_%H-%M-%S)"
echo "" >> "$LOGFILE"
echo "â•­â”€ ${HEADER} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> "$LOGFILE"
echo "â”‚  ðŸ“ Original Size .............. $ORIG_SIZE                       " >> "$LOGFILE"
echo "â”‚  ðŸ’¾ Compressed Size ............ $COMP_SIZE                       " >> "$LOGFILE"
echo "â”‚  âš¡ Compression Time ........... ${COMP_TIME}s                     " >> "$LOGFILE"
echo "â”‚  ðŸš€ SCP Transfer Time ......... ${SCP_TIME}s                      " >> "$LOGFILE"
echo "â”‚  â±ï¸  Total Time ................ ${TOTAL_TIME}s                    " >> "$LOGFILE"
echo "â”‚  ðŸ§¹ Cleanup ................... $CLEANUP_STATUS                    " >> "$LOGFILE"
echo "â”‚                                                             " >> "$LOGFILE"
echo "â”‚  âœ… Destination: E:/IskeleDailyBackups/tm_Backup_${TIMESTAMP}.tar.zst" >> "$LOGFILE"
echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> "$LOGFILE"
echo "" >> "$LOGFILE"

echo "âœ… Backup tamamlandÄ±! Log: $LOGFILE"
